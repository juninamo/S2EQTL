---
title: "Code for generating dummy single-cell expression data"
author: 
  name: Jun Inamo
  email: jun.inamo@cuanschutz.edu
  affiliation: Computational Omics and Systems Immunology (COSI) Lab, Division of Rheumatology and Center for Health AI, University of Colorado School of Medicine, CO, USA
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  BiocStyle::html_document:
    toc_float: true
---



```{r, echo=FALSE, results="hide", message=FALSE}
knitr::opts_chunk$set(error=FALSE, message=FALSE, warning=FALSE)
# BiocManager::install("BiocStyle")
library(BiocStyle)

```

```{r, message=FALSE, warning=FALSE}

getwd()
source("./functions.R")

```


# Set parameters

```{r}

n_thread=4
registerDoParallel(cores = thread)  # use forking with X cores

# parameters for generating dummy dataset
n_cells=200 # cells per individual
sd_celltypes=0.1  # standard deviation of number of cells 
n_major_cell_types=7
n_minor_cell_types=3
relative_abundance=0.4 # ratio between major and rare
n_major_diff_celltypes=1
n_minor_diff_celltypes=1
n_individuals=20 # total individuals
n_batchs=4
prop_sex=0.5 # proportion of feature 1 if feature 1 is categorical variable
prop_disease=0.5  # proportion of feature 2 if feature 2 is categorical variable
# interaction_feature_1="sex"
# interaction_feature_2="disease"
# interaction_feature_1="age"
# interaction_feature_2="bmi"
fc_increase=0.5 # proportion of interacted cells which are from people with interacted group
# interaction_type="specific" # c("specific","differential","opposite")
seed=1234

print(paste0("n_thread: ", n_thread))
print(paste0("n_cells: ", n_cells))
print(paste0("sd_celltypes: ", sd_celltypes))
print(paste0("n_major_cell_types: ", n_major_cell_types))
print(paste0("n_minor_cell_types: ", n_minor_cell_types))
print(paste0("relative_abundance: ", relative_abundance))
print(paste0("n_major_diff_celltypes: ", n_major_diff_celltypes))
print(paste0("n_minor_diff_celltypes: ", n_minor_diff_celltypes))
print(paste0("n_individuals: ", n_individuals))
print(paste0("n_batchs: ", n_batchs))
print(paste0("prop_sex: ", prop_sex))
print(paste0("prop_disease: ", prop_disease))
print(paste0("fc_increase: ", fc_increase))
print(paste0("seed: ", seed))

n_features = 1000
cluster_features = 1:200
disease_features = 1:200
sex_features = 1:200 # seq(2, 20, by = 2)
age_features = 1:200 # seq(2, 10, by = 2)
bmi_features = 1:200 # seq(11, 20, by = 2)
batch_features = 1:200 # seq(1, 20,by = 2)
individual_features = 1:200 # seq(1, 20,by = 2)

# Define the maximum variance in features of each attribute
cluster_ratio = 0.25
disease_ratio = 0.05
sex_ratio = 0.05 # 0.05
age_ratio = 0.05 # 0.05
bmi_ratio = 0.05 # 0.05
batch_ratio = 0.05 # 0.1
individual_ratio = 0.05 # 0.1

n_pcs = 20

ratio_variance = 0.1

cluster_col = "cell_type"
sex_col = "sex"
age_col = "age"
bmi_col = "bmi"
batch_col = "batch"
disease_col = "disease"
individual_col = 'subject_id'

# parameters for UMAP
n_neighbors = 30
metric = "cosine"
min_dist = 0.01

# downsampling parameter for MASC to save time(1 means no downsampling)
ds_pro = 1 

# parameters for CNA
test_var="condition_val"
samplem_key = 'subject_id'
graph_use = 'RNA_nn'
batches = "batch"

nsteps = NULL
verbose=TRUE
assay=NULL
key='NAMPC_'
maxnsteps=15L
max_frac_pcs=0.15
ks=NULL
Nnull=1000
force_permute_all=FALSE
local_test=TRUE
return_nam=TRUE

```



# Generating dummy data

```{r, warning=FALSE}

dummy_data <- generate_dummy_metadata(n_cells = n_cells, # cells per individual
                                                sd_celltypes = sd_celltypes,  # standard deviation of number of cells 
                                                n_major_cell_types = n_major_cell_types,
                                                n_minor_cell_types = n_minor_cell_types,
                                                relative_abundance = relative_abundance, # ratio between major and rare
                                                n_major_diff_celltypes = n_major_diff_celltypes,
                                                n_minor_diff_celltypes = n_minor_diff_celltypes,
                                                
                                                n_individuals = n_individuals, # total individuals
                                                n_batchs = n_batchs,
                                                prop_sex = prop_sex, # proportion of feature 1 if feature 1 is categorical variable
                                                prop_disease = prop_disease,  # proportion of feature 2 if feature 2 is categorical variable
                                                fc_increase = fc_increase, # additional FC of specified cell types which are from people with case groups compared to control groups (e.g., if you specify 0.5, FC comparing increased cell type between case and control groups will be 1.5 in total)
                                                seed = seed
)
diff_cell_types = dummy_data[[2]]
dummy_data = dummy_data[[1]]

diff_cell_types
head(dummy_data)
dim(dummy_data)

dummy_data %>%
  dplyr::group_by(cell_type,subject_id,disease) %>%
  dplyr::summarise(count = dplyr::n()) %>%
  dplyr::filter(cell_type %in% diff_cell_types) %>%
  as.data.frame()

message(paste0("Fold change of ", paste0(diff_cell_types,collapse=","), " should be ", 1+fc_increase))
dummy_data %>%
  dplyr::group_by(cell_type,subject_id,disease) %>%
  dplyr::summarise(count = dplyr::n()) %>%
  dplyr::group_by(cell_type, disease) %>%
  dplyr::summarise(
    median_count = median(count), # 平均
    .groups = 'drop'
  ) %>%
  dplyr::ungroup() %>%
  tidyr::spread(key = disease, value = median_count) %>%
  dplyr::rename(median_count_disease_0 = `0`, median_count_disease_1 = `1`) %>%
  dplyr::mutate(
    fold_change = median_count_disease_1 / median_count_disease_0
  ) %>%
  dplyr::select(cell_type, median_count_disease_0, median_count_disease_1, fold_change)

# Generate 20 pseudo principal components for the data
## with the assumption that covariates including sex are removed after harmonization
pseudo_feature_matrix <- generate_pseudo_features(dummy_data, 
                                                  n_features = n_features, 
                                                  cluster_features = cluster_features,
                                                  disease_features = disease_features,
                                                  sex_features = sex_features, 
                                                  age_features = age_features,
                                                  bmi_features = bmi_features,
                                                  batch_features = batch_features,
                                                  individual_features = individual_features,
                                                  
                                                  # 各属性の割合の最大値を定義
                                                  cluster_ratio = cluster_ratio,
                                                  disease_ratio = disease_ratio,
                                                  sex_ratio = sex_ratio,
                                                  age_ratio = age_ratio,
                                                  bmi_ratio = bmi_ratio,
                                                  batch_ratio = batch_ratio,
                                                  individual_ratio = individual_ratio,
                                                  
                                                  ratio_variance = ratio_variance,
                                                  
                                                  cluster_col = cluster_col,
                                                  sex_col = sex_col,
                                                  age_col = age_col,
                                                  bmi_col = bmi_col,
                                                  batch_col = batch_col,
                                                  disease_col = disease_col,
                                                  individual_col = individual_col,
                                                  seed = seed,
                                                  
                                                  n_thread = 4,
                                                  verbose = TRUE
)
colnames(pseudo_feature_matrix) <- paste0("Feature", 1:ncol(pseudo_feature_matrix))

```



# Inspect the generated dummy data

```{r, fig.height=5, fig.width=6, warning=FALSE, message=FALSE}

# Set up a cluster using the available cores minus one
cl <- makeCluster(n_thread)

# Export the necessary objects and functions to the cluster
clusterExport(cl, list("apply_model_to_column", "dummy_data", "pseudo_feature_matrix"))

# Load the necessary packages on each worker
clusterEvalQ(cl, {
  library(lme4)
  library(variancePartition)
})

# Use parLapply to apply the function in parallel and capture errors
results_1 <- parLapply(cl, 1:10, function(col_index) {
  column_data <- pseudo_feature_matrix[, col_index]
  tryCatch({
    apply_model_to_column(column_data)
  }, error = function(e) {
    return(list(error = e$message))
  })
})

results_2 <- parLapply(cl, (ncol(pseudo_feature_matrix)-9):ncol(pseudo_feature_matrix), function(col_index) {
  column_data <- pseudo_feature_matrix[, col_index]
  tryCatch({
    apply_model_to_column(column_data)
  }, error = function(e) {
    return(list(error = e$message))
  })
})

stopCluster(cl)

results = c(results_1, results_2)

# Check for errors
## errors <- sapply(results, function(x) if(is.list(x)) x$error else NA)
## errors

# Assuming 'results' is your list of variance partitions
# Convert the list of results to a data frame
results_df <- do.call(rbind, lapply(results, function(x) as.data.frame(t(x))))
colnames(results_df) <- c('batch', 'cell_type', 'disease', 'sex', 'subject_id', 'age', 'bmi', 'Residuals')
results_df$Feature <- paste0("Feature", rownames(results_df))

# Convert the results into a long format for ggplot
results_long <- tidyr::gather(results_df, key = "variable", value = "variance", -Feature)

# Compute the percentage of variance explained by each variable for each Feature
results_long <- results_long %>%
  dplyr::group_by(Feature) %>%
  dplyr::mutate(percentage = (variance / sum(variance)) * 100) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Feature = factor(Feature, levels = paste0("Feature", 1:length(unique(results_long$Feature)))),
                variable = factor(variable, levels = c('cell_type', 'batch', 'disease', 'sex', 'subject_id', 'age', 'bmi', 'Residuals')))

# Create the stacked bar plot
ggplot(results_long, aes(x = Feature, y = percentage, fill = variable)) +
  geom_bar(stat = "identity") +
  labs(x = "Features", y = "Variance Explained (%)", title = "Variance Explained") +
  coord_flip() +
  scale_fill_brewer(palette = "Dark2") +
  theme_minimal() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)
        )

```

make PC matrix from Feature matrix;
batch effectなどが残っているシミュレーションをしているので、普通のPCAを使う

```{r}
pseudo_pcs_matrix_res <- irlba::prcomp_irlba(pseudo_feature_matrix, n_pcs)
pseudo_pcs_matrix_res$sdev^2 / sum(pseudo_pcs_matrix_res$sdev^2)
pseudo_pcs_matrix = pseudo_pcs_matrix_res$x
colnames(pseudo_pcs_matrix) <- paste0("PC", 1:ncol(pseudo_pcs_matrix))
```

```{r, fig.height=5, fig.width=6, warning=FALSE}

# Set up a cluster using the available cores minus one
cl <- makeCluster(n_thread)

# Export the necessary objects and functions to the cluster
clusterExport(cl, list("apply_model_to_column", "dummy_data", "pseudo_pcs_matrix"))

# Load the necessary packages on each worker
clusterEvalQ(cl, {
  library(lme4)
  library(variancePartition)
})

# Use parLapply to apply the function in parallel and capture errors
results <- parLapply(cl, 1:ncol(pseudo_pcs_matrix), function(col_index) {
  column_data <- pseudo_pcs_matrix[, col_index]
  tryCatch({
    apply_model_to_column(column_data)
  }, error = function(e) {
    return(list(error = e$message))
  })
})

stopCluster(cl)

# Check for errors
## errors <- sapply(results, function(x) if(is.list(x)) x$error else NA)
## errors

# Assuming 'results' is your list of variance partitions
# Convert the list of results to a data frame
results_df <- do.call(rbind, lapply(results, function(x) as.data.frame(t(x))))
colnames(results_df) <- c('batch', 'cell_type', 'disease', 'sex', 'subject_id', 'age', 'bmi', 'Residuals')
results_df$PC <- paste0("PC", rownames(results_df))

# Convert the results into a long format for ggplot
results_long <- tidyr::gather(results_df, key = "variable", value = "variance", -PC)

# Compute the percentage of variance explained by each variable for each PC
results_long <- results_long %>%
  dplyr::group_by(PC) %>%
  dplyr::mutate(percentage = (variance / sum(variance)) * 100) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(PC = factor(PC, levels = paste0("PC", 1:ncol(pseudo_pcs_matrix))),
                variable = factor(variable, levels = c('cell_type', 'batch', 'disease', 'sex', 'subject_id', 'age', 'bmi', 'Residuals')))

# Create the stacked bar plot
ggplot(results_long, aes(x = PC, y = percentage, fill = variable)) +
  geom_bar(stat = "identity") +
  labs(x = "Principal Component", y = "Variance Explained (%)", title = "Variance Explained") +
  coord_flip() +
  scale_fill_brewer(palette = "Dark2") +
  theme_minimal() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)
        )


```

```{r, message=FALSE, warning=FALSE, fig.height=6, fig.width=12}

dummy_data_with_pcs <- cbind(dummy_data, pseudo_pcs_matrix)
head(dummy_data_with_pcs)

cluster_center <- dummy_data_with_pcs %>%
  dplyr::group_by(cell_type) %>%
  dplyr::summarise_at(vars(PC1, PC2), dplyr::funs(median(., na.rm=TRUE)))
cluster_center <- as.data.frame(cluster_center)
ggplot() +
  geom_point(
    data = dummy_data_with_pcs,
    mapping = aes_string(x = "PC1", y = "PC2", color = "cell_type"),
    size = 1, stroke = 0, shape = 16,alpha = 0.5
  ) +
  geom_label_repel(
    data = cluster_center,
    aes(x = PC1, y = PC2, label = cell_type, fill = cell_type),
    color = "white",segment.color = "black",
    size = 7,
    min.segment.length = 0, seed = 42, box.padding = 0.8,
    max.overlaps = Inf
  ) +
  labs(
    x = "PC1",
    y = "PC2",
    title = ""
  ) +
  coord_fixed(ratio = 1) +
  theme_bw(base_size = 20) +
  theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_text(color="black", size=10)
  ) 
dummy_data_with_pcs %>%
  dplyr::select(cell_type, starts_with("PC")) %>%
  pivot_longer(!cell_type, names_to = "PC", values_to = "value") %>%
  dplyr::mutate(PC = factor(PC, levels=paste0("PC",1:20))) %>%
  ggplot(., aes(x = value, y = cell_type)) +
  ggridges::geom_density_ridges(aes(fill = cell_type, color = cell_type), scale = 1) +
  facet_wrap(PC ~ ., ncol = 10, scales = "free") +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "loadings",
       y = "cell clusters") 
dummy_data_with_pcs %>%
  dplyr::select(disease, starts_with("PC")) %>%
  pivot_longer(!disease, names_to = "PC", values_to = "value") %>%
  dplyr::mutate(PC = factor(PC, levels=paste0("PC",1:20))) %>%
  ggplot(., aes(x = value, y = disease)) +
  ggridges::geom_density_ridges(aes(fill = disease, color = disease), scale = 1) +
  facet_wrap(PC ~ ., ncol = 10, scales = "free") +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "loadings",
       y = "disease") 
dummy_data_with_pcs %>%
  dplyr::select(batch, starts_with("PC")) %>%
  pivot_longer(!batch, names_to = "PC", values_to = "value") %>%
  dplyr::mutate(PC = factor(PC, levels=paste0("PC",1:20))) %>%
  ggplot(., aes(x = value, y = batch)) +
  ggridges::geom_density_ridges(aes(fill = batch, color = batch), scale = 1) +
  facet_wrap(PC ~ ., ncol = 10, scales = "free") +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "loadings",
       y = "batch") 
dummy_data_with_pcs %>%
  dplyr::select(sex, starts_with("PC")) %>%
  pivot_longer(!sex, names_to = "PC", values_to = "value") %>%
  dplyr::mutate(PC = factor(PC, levels=paste0("PC",1:20))) %>%
  ggplot(., aes(x = value, y = sex)) +
  ggridges::geom_density_ridges(aes(fill = sex, color = sex), scale = 1) +
  facet_wrap(PC ~ ., ncol = 10, scales = "free") +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "loadings",
       y = "sex") 

corrplot::corrplot(cor(pseudo_pcs_matrix))
```


# UMAP

```{r, message=FALSE, warning=FALSE}
umap_res <- uwot::umap(pseudo_pcs_matrix, 
                       n_neighbors = n_neighbors, 
                       metric = "cosine", 
                       min_dist = min_dist, 
                       n_threads = n_thread)
umap_res = umap_res %>% 
  magrittr::set_colnames(c("UMAP1","UMAP2")) %>%
  as.data.frame()

dummy_data_with_umap <- cbind(dummy_data, umap_res)
head(dummy_data_with_umap)

cluster_center <- data.frame(dummy_data, umap_res) %>%
  dplyr::group_by(cell_type) %>%
  dplyr::summarise_at(vars(UMAP1, UMAP2), dplyr::funs(median(., na.rm=TRUE)))
cluster_center <- as.data.frame(cluster_center)
ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "cell_type"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  geom_label_repel(
    data = cluster_center,
    aes(x = UMAP1, y = UMAP2, label = cell_type, fill = cell_type),
    color = "white",segment.color = "black",
    size = 7,
    min.segment.length = 0, seed = 42, box.padding = 0.8,
    max.overlaps = Inf
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = ""
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "subject_id"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by subject_id"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "disease"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by disease"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "batch"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by batch"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "age"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by age"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "bmi"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by bmi"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "sex"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by sex"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))
```

# LISI score

```{r}
lisi_res <- rbind(
  lisi::compute_lisi(pseudo_pcs_matrix, 
                     dummy_data,
                     c("subject_id", "sex", "disease", "batch", "cell_type"))
) %>% 
  tidyr::gather(key, val, subject_id, sex, disease, batch, cell_type)
print(head(lisi_res))

assign(paste0("lisi_res_cluster", cluster_ratio,
              "_disease", disease_ratio, 
              "_sex", sex_ratio, 
              "_age", age_ratio,
              "_bmi", bmi_ratio,
              "_batch", batch_ratio,
              "_individual", individual_ratio
              ), lisi_res)
```


confirm NO interaction effect using MASC(Mixed effect model)

```{r, warning=FALSE}

ds_indexes <- unlist(lapply(split(1:nrow(dummy_data), dummy_data$subject_id),
                            FUN, n = 0, frac = ds_pro))
masc_df = dummy_data[ds_indexes,]
masc_df$subject_id = factor(masc_df$subject_id)
masc_df <- masc_df %>%
  mutate_if(is.numeric, scale)

# NO interaction effect between sex and disease
masc_SxD = GLM_interact(dataset = masc_df,
                    cluster = masc_df$cell_type,
                    contrast1 = sex_col,
                    contrast2 = disease_col,
                    random_effects = c(samplem_key,batch_col),
                    fixed_effects = age_col,
                    verbose = TRUE, save_models = FALSE)
masc_SxD

# NO interaction effect between age and disease
masc_AxD = GLM_interact(dataset = masc_df,
                    cluster = masc_df$cell_type,
                    contrast1 = age_col,
                    contrast2 = disease_col,
                    random_effects = c(samplem_key,batch_col, sex_col),
                    fixed_effects = NULL,
                    verbose = TRUE, save_models = FALSE)
masc_AxD
```


# Association test by disease using CNA

```{r, warning=FALSE, message=FALSE}

dummy_data$condition_val = as.numeric(dummy_data[,disease_col])

nam_res = association_nam(seurat_object=NULL,
                          metadata=dummy_data,
                          pcs=pseudo_pcs_matrix,
                          test_var=test_var,
                          samplem_key = samplem_key,
                          graph_use = graph_use,
                          batches = batches,
                          covs = c(age_col,sex_col),
                          nsteps = nsteps,
                          verbose=verbose,
                          assay=assay,
                          key=key,
                          maxnsteps=maxnsteps,
                          max_frac_pcs=max_frac_pcs, # added option to pass number of PCs, for potential speedups
                          ks=ks,
                          Nnull=Nnull,
                          force_permute_all=force_permute_all,
                          local_test=local_test,
                          seed=seed,
                          return_nam=return_nam
)

```


# Visualization

```{r, fig.width=17, fig.height=25, warning=FALSE}


g0 = dummy_data %>%
  dplyr::group_by(subject_id,sex,disease,cell_type) %>%
  dplyr::summarise(count = dplyr::n()) %>%
  dplyr::group_by(subject_id,sex,disease) %>%
  dplyr::mutate(proportion = 100*count/sum(count),
                sex_label = ifelse(sex=="0","Male","Female"),
                disease_label = ifelse(disease=="0","Control","Disease")) %>%
  ggplot(.,aes(x=disease_label,y=proportion,color = disease_label)) +
  geom_boxplot() +
  geom_point(position=position_jitterdodge(0.9)) +
  ggpubr::stat_compare_means(comparisons = list(c("Control","Disease")), 
                             label = "{p.adj}{p.adj.signif}", method = "wilcox.test", label.y.npc = 0.4, tip.length = 0) +
  scale_color_manual(values = c(
    "Control" = "#4DAF4A",
    "Disease" = "#984EA3")) +
  ggh4x::facet_nested_wrap(vars(cell_type), nrow = 1) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15, angle = 45, hjust = 1),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(
    x = "Disease status",
    y = "Proportion (%)",
    title = ""
  )  


g1 = dummy_data %>%
  dplyr::group_by(subject_id,sex,disease,cell_type) %>%
  dplyr::summarise(count = dplyr::n()) %>%
  dplyr::group_by(subject_id,sex,disease) %>%
  dplyr::mutate(proportion = 100*count/sum(count),
                sex_label = ifelse(sex=="0","Male","Female"),
                disease_label = ifelse(disease=="0","Control","Disease")) %>%
  ggplot(.,aes(x=disease_label,y=proportion,color = disease_label)) +
  geom_boxplot() +
  geom_point(position=position_jitterdodge(0.9)) +
  ggpubr::stat_compare_means(comparisons = list(c("Control","Disease")), 
                             label = "{p.adj}{p.adj.signif}", method = "wilcox.test", label.y.npc = 0.4, tip.length = 0) +
  scale_color_manual(values = c(
    "Control" = "#4DAF4A",
    "Disease" = "#984EA3")) +
  ggh4x::facet_nested_wrap(vars(cell_type, sex_label), nrow = 1) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15, angle = 45, hjust = 1),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(
    x = "Disease status",
    y = "Proportion (%)",
    title = ""
  )  


cluster_center <- data.frame(dummy_data, umap_res) %>%
  dplyr::group_by(cell_type) %>%
  dplyr::summarise_at(vars(UMAP1, UMAP2), dplyr::funs(median(., na.rm=TRUE)))
cluster_center <- as.data.frame(cluster_center)
g2 = ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "cell_type"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  geom_label_repel(
    data = cluster_center,
    aes(x = UMAP1, y = UMAP2, label = cell_type, fill = cell_type),
    color = "white",segment.color = "black",
    size = 7,
    min.segment.length = 0, seed = 42, box.padding = 0.8,
    max.overlaps = Inf
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = ""
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

g3 = 
  data.frame(dummy_data_with_umap[,c("UMAP1","UMAP2")], ncorrs = nam_res@meta.data$cna_ncorrs_fdr05) %>%
  ggplot() +
  geom_point(aes(x = UMAP1, y = UMAP2, color = ncorrs, alpha = abs(ncorrs)), size = 0.01) +
  scale_color_gradient2(midpoint = 0, low = '#3C5488FF', mid = "grey90", high = '#DC0000FF', space = "Lab" ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = paste0("Disease association\n",sprintf("global p=%0.3f",nam_res@reductions$cna@misc$p)," [Filtered for FDR<0.05]"), 
    color = paste0("correlation"),
    alpha = paste0("correlation")
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

cor_pos = nam_res@meta.data$cna_ncorrs_fdr05
cor_pos = cor_pos[cor_pos > 0]
# summary(cor_pos)
cor_neg = nam_res@meta.data$cna_ncorrs_fdr05
cor_neg = cor_neg[cor_neg < 0]
# summary(cor_neg)
ord = sort(unique(dummy_data$cell_type))
p_ <- data.frame(dummy_data_with_umap[,c("UMAP1","UMAP2")], ncorrs = nam_res[["cna"]]@misc$ncorrs, res_cell = dummy_data$cell_type) %>%
  dplyr::mutate(res_cell = factor(res_cell,levels=ord)) %>%
  ggplot(aes(x=res_cell, y=ncorrs)) + 
  geom_violin(trim=TRUE, scale = "width")
mywidth <- .35 # bit of trial and error
# This is all you need for the fill: 
vl_fill <- data.frame(ggplot_build(p_)$data) %>%
  mutate(xnew = x- mywidth*violinwidth, xend = x+ mywidth*violinwidth) 
# Bit convoluted for the outline, need to be rearranged: the order matters
vl_poly <- 
  vl_fill %>% 
  dplyr::select(xnew, xend, y, group) %>%
  pivot_longer(-c(y, group), names_to = "oldx", values_to = "x") %>% 
  arrange(y) %>%
  split(., .$oldx) %>%
  map(., function(x) {
    if(all(x$oldx == "xnew")) x <- arrange(x, desc(y))
    x
  }) %>%
  bind_rows()
g4 = ggplot() +
  geom_polygon(data = vl_poly, aes(x, y, group = group), size = 1, fill = NA) +  
  geom_segment(data = vl_fill, aes(x = xnew, xend = xend, y = y, yend = y, color = y)) +
  scale_color_gradient2(midpoint = 0, low = '#3C5488FF', mid = "white", high = '#DC0000FF', space = "Lab") +
  scale_x_continuous(labels=ord, breaks=1:length(unique(ord)) , limits=c(min(vl_poly$x),max(vl_poly$x))) +
  geom_hline(yintercept=0, linetype='dashed', color='black') +
  geom_hline(yintercept=c(min(cor_pos), max(cor_neg)), linetype='dotted', color='grey45') +
  theme_classic() +
  coord_flip() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size =15),
        axis.text.x = element_text(size =15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "",
       y = "Neighborhood\nCorrelation") 

ord = c(paste0(rep(sort(unique(dummy_data$cell_type)),each=2),c(".Female",".Male")))
p_ <- data.frame(dummy_data_with_umap[,c("UMAP1","UMAP2")], ncorrs = nam_res@meta.data$cna_ncorrs, res_cell = dummy_data[,cluster_col], sex = ifelse(dummy_data[,sex_col]==1, "Female", "Male")) %>%
  dplyr::mutate(new_x = interaction(res_cell, sex),
                new_x = factor(new_x, levels=ord)) %>%
  ggplot(aes(x=new_x, y=ncorrs)) + 
  geom_violin(trim=TRUE, scale = "width") +
  scale_color_gradient2(midpoint = 0, low = '#3C5488FF', mid = "white", high = '#DC0000FF', space = "Lab")
mywidth <- .35 # bit of trial and error
# This is all you need for the fill: 
vl_fill <- data.frame(ggplot_build(p_)$data) %>%
  mutate(xnew = x- mywidth*violinwidth, xend = x+ mywidth*violinwidth) 
# Bit convoluted for the outline, need to be rearranged: the order matters
vl_poly <- 
  vl_fill %>% 
  dplyr::select(xnew, xend, y, group) %>%
  pivot_longer(-c(y, group), names_to = "oldx", values_to = "x") %>% 
  arrange(y) %>%
  split(., .$oldx) %>%
  map(., function(x) {
    if(all(x$oldx == "xnew")) x <- arrange(x, desc(y))
    x
  }) %>%
  bind_rows()
g5 =  ggplot() +
  geom_polygon(data = vl_poly, aes(x, y, group = group), size = 1, fill = NA) +  
  geom_segment(data = vl_fill, aes(x = xnew, xend = xend, y = y, yend = y, color = y)) +
  scale_color_gradient2(midpoint = 0, low = '#3C5488FF', mid = "white", high = '#DC0000FF', space = "Lab") +
  scale_x_continuous(labels=ord, breaks=1:length(ord) , limits=c(min(vl_poly$x),max(vl_poly$x))) +
  geom_hline(yintercept=0, linetype='dashed', color='black') +
  geom_hline(yintercept=c(min(cor_pos), max(cor_neg)), linetype='dotted', color='grey45') +
  theme_classic() +
  coord_flip() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size =12),
        axis.text.x = element_text(size =15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "",
       y = "Neighborhood\nCorrelation") 


(g0) / 
(g1) / 
  (g2 + g3 ) / 
  ((g4 + g5 ) + patchwork::plot_layout(nrow = 1, heights = c(1, 1, 1, 0.1)))




```

# Decrease cluster_ratio and increase batch_ratio 


```{r}
# Define the maximum variance in PCs of each attribute
cluster_ratio2 = 0.2
batch_ratio2 = 0.1
```



# Generating dummy data

```{r, warning=FALSE}

dummy_data <- generate_dummy_metadata(n_cells = n_cells, # cells per individual
                                                sd_celltypes = sd_celltypes,  # standard deviation of number of cells 
                                                n_major_cell_types = n_major_cell_types,
                                                n_minor_cell_types = n_minor_cell_types,
                                                relative_abundance = relative_abundance, # ratio between major and rare
                                                n_major_diff_celltypes = n_major_diff_celltypes,
                                                n_minor_diff_celltypes = n_minor_diff_celltypes,
                                                
                                                n_individuals = n_individuals, # total individuals
                                                n_batchs = n_batchs,
                                                prop_sex = prop_sex, # proportion of feature 1 if feature 1 is categorical variable
                                                prop_disease = prop_disease,  # proportion of feature 2 if feature 2 is categorical variable
                                                fc_increase = fc_increase, # additional FC of specified cell types which are from people with case groups compared to control groups (e.g., if you specify 0.5, FC comparing increased cell type between case and control groups will be 1.5 in total)
                                                seed = seed
)
diff_cell_types = dummy_data[[2]]
dummy_data = dummy_data[[1]]

diff_cell_types
head(dummy_data)
dim(dummy_data)

dummy_data %>%
  dplyr::group_by(cell_type,subject_id,disease) %>%
  dplyr::summarise(count = dplyr::n()) %>%
  dplyr::filter(cell_type %in% diff_cell_types) %>%
  as.data.frame()

message(paste0("Fold change of ", paste0(diff_cell_types,collapse=","), " should be ", 1+fc_increase))
dummy_data %>%
  dplyr::group_by(cell_type,subject_id,disease) %>%
  dplyr::summarise(count = dplyr::n()) %>%
  dplyr::group_by(cell_type, disease) %>%
  dplyr::summarise(
    median_count = median(count), # 平均
    .groups = 'drop'
  ) %>%
  dplyr::ungroup() %>%
  tidyr::spread(key = disease, value = median_count) %>%
  dplyr::rename(median_count_disease_0 = `0`, median_count_disease_1 = `1`) %>%
  dplyr::mutate(
    fold_change = median_count_disease_1 / median_count_disease_0
  ) %>%
  dplyr::select(cell_type, median_count_disease_0, median_count_disease_1, fold_change)



# Generate 20 pseudo principal components for the data
## with the assumption that covariates including sex are removed after harmonization
pseudo_feature_matrix <- generate_pseudo_features(dummy_data, 
                                                  n_features = n_features, 
                                                  cluster_features = cluster_features,
                                                  disease_features = disease_features,
                                                  sex_features = sex_features, 
                                                  age_features = age_features,
                                                  bmi_features = bmi_features,
                                                  batch_features = batch_features,
                                                  individual_features = individual_features,
                                                  
                                                  # 各属性の割合の最大値を定義
                                                  cluster_ratio = cluster_ratio2,
                                                  disease_ratio = disease_ratio,
                                                  sex_ratio = sex_ratio,
                                                  age_ratio = age_ratio,
                                                  bmi_ratio = bmi_ratio,
                                                  batch_ratio = batch_ratio2,
                                                  individual_ratio = individual_ratio,
                                                  
                                                  ratio_variance = ratio_variance,
                                                  
                                                  cluster_col = cluster_col,
                                                  sex_col = sex_col,
                                                  age_col = age_col,
                                                  bmi_col = bmi_col,
                                                  batch_col = batch_col,
                                                  disease_col = disease_col,
                                                  individual_col = individual_col,
                                                  seed = seed,
                                                  
                                                  n_thread = 4,
                                                  verbose = TRUE
)
colnames(pseudo_feature_matrix) <- paste0("Feature", 1:ncol(pseudo_feature_matrix))


```



# Inspect the generated dummy data

```{r, fig.height=5, fig.width=6, warning=FALSE, message=FALSE}

# Set up a cluster using the available cores minus one
cl <- makeCluster(n_thread)

# Export the necessary objects and functions to the cluster
clusterExport(cl, list("apply_model_to_column", "dummy_data", "pseudo_feature_matrix"))

# Load the necessary packages on each worker
clusterEvalQ(cl, {
  library(lme4)
  library(variancePartition)
})

# Use parLapply to apply the function in parallel and capture errors
results_1 <- parLapply(cl, 1:10, function(col_index) {
  column_data <- pseudo_feature_matrix[, col_index]
  tryCatch({
    apply_model_to_column(column_data)
  }, error = function(e) {
    return(list(error = e$message))
  })
})

results_2 <- parLapply(cl, (ncol(pseudo_feature_matrix)-9):ncol(pseudo_feature_matrix), function(col_index) {
  column_data <- pseudo_feature_matrix[, col_index]
  tryCatch({
    apply_model_to_column(column_data)
  }, error = function(e) {
    return(list(error = e$message))
  })
})

stopCluster(cl)

results = c(results_1, results_2)

# Check for errors
## errors <- sapply(results, function(x) if(is.list(x)) x$error else NA)
## errors

# Assuming 'results' is your list of variance partitions
# Convert the list of results to a data frame
results_df <- do.call(rbind, lapply(results, function(x) as.data.frame(t(x))))
colnames(results_df) <- c('batch', 'cell_type', 'disease', 'sex', 'subject_id', 'age', 'bmi', 'Residuals')
results_df$Feature <- paste0("Feature", rownames(results_df))

# Convert the results into a long format for ggplot
results_long <- tidyr::gather(results_df, key = "variable", value = "variance", -Feature)

# Compute the percentage of variance explained by each variable for each Feature
results_long <- results_long %>%
  dplyr::group_by(Feature) %>%
  dplyr::mutate(percentage = (variance / sum(variance)) * 100) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Feature = factor(Feature, levels = paste0("Feature", 1:length(unique(results_long$Feature)))),
                variable = factor(variable, levels = c('cell_type', 'batch', 'disease', 'sex', 'subject_id', 'age', 'bmi', 'Residuals')))

# Create the stacked bar plot
ggplot(results_long, aes(x = Feature, y = percentage, fill = variable)) +
  geom_bar(stat = "identity") +
  labs(x = "Features", y = "Variance Explained (%)", title = "Variance Explained") +
  coord_flip() +
  scale_fill_brewer(palette = "Dark2") +
  theme_minimal() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)
        )

```

make PC matrix from Feature matrix;
batch effectなどが残っているシミュレーションをしているので、普通のPCAを使う

```{r}
pseudo_pcs_matrix_res <- irlba::prcomp_irlba(pseudo_feature_matrix, n_pcs)
pseudo_pcs_matrix_res$sdev^2 / sum(pseudo_pcs_matrix_res$sdev^2)
pseudo_pcs_matrix = pseudo_pcs_matrix_res$x
colnames(pseudo_pcs_matrix) <- paste0("PC", 1:ncol(pseudo_pcs_matrix))
```

```{r, fig.height=5, fig.width=6, warning=FALSE}

# Set up a cluster using the available cores minus one
cl <- makeCluster(n_thread)

# Export the necessary objects and functions to the cluster
clusterExport(cl, list("apply_model_to_column", "dummy_data", "pseudo_pcs_matrix"))

# Load the necessary packages on each worker
clusterEvalQ(cl, {
  library(lme4)
  library(variancePartition)
})

# Use parLapply to apply the function in parallel and capture errors
results <- parLapply(cl, 1:ncol(pseudo_pcs_matrix), function(col_index) {
  column_data <- pseudo_pcs_matrix[, col_index]
  tryCatch({
    apply_model_to_column(column_data)
  }, error = function(e) {
    return(list(error = e$message))
  })
})

stopCluster(cl)

# Check for errors
## errors <- sapply(results, function(x) if(is.list(x)) x$error else NA)
## errors

# Assuming 'results' is your list of variance partitions
# Convert the list of results to a data frame
results_df <- do.call(rbind, lapply(results, function(x) as.data.frame(t(x))))
colnames(results_df) <- c('batch', 'cell_type', 'disease', 'sex', 'subject_id', 'age', 'bmi', 'Residuals')
results_df$PC <- paste0("PC", rownames(results_df))

# Convert the results into a long format for ggplot
results_long <- tidyr::gather(results_df, key = "variable", value = "variance", -PC)

# Compute the percentage of variance explained by each variable for each PC
results_long <- results_long %>%
  dplyr::group_by(PC) %>%
  dplyr::mutate(percentage = (variance / sum(variance)) * 100) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(PC = factor(PC, levels = paste0("PC", 1:ncol(pseudo_pcs_matrix))),
                variable = factor(variable, levels = c('cell_type', 'batch', 'disease', 'sex', 'subject_id', 'age', 'bmi', 'Residuals')))

# Create the stacked bar plot
ggplot(results_long, aes(x = PC, y = percentage, fill = variable)) +
  geom_bar(stat = "identity") +
  labs(x = "Principal Component", y = "Variance Explained (%)", title = "Variance Explained") +
  coord_flip() +
  scale_fill_brewer(palette = "Dark2") +
  theme_minimal() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)
        )


```

```{r, message=FALSE, warning=FALSE, fig.height=6, fig.width=12}

dummy_data_with_pcs <- cbind(dummy_data, pseudo_pcs_matrix)
head(dummy_data_with_pcs)

cluster_center <- dummy_data_with_pcs %>%
  dplyr::group_by(cell_type) %>%
  dplyr::summarise_at(vars(PC1, PC2), dplyr::funs(median(., na.rm=TRUE)))
cluster_center <- as.data.frame(cluster_center)
ggplot() +
  geom_point(
    data = dummy_data_with_pcs,
    mapping = aes_string(x = "PC1", y = "PC2", color = "cell_type"),
    size = 1, stroke = 0, shape = 16,alpha = 0.5
  ) +
  geom_label_repel(
    data = cluster_center,
    aes(x = PC1, y = PC2, label = cell_type, fill = cell_type),
    color = "white",segment.color = "black",
    size = 7,
    min.segment.length = 0, seed = 42, box.padding = 0.8,
    max.overlaps = Inf
  ) +
  labs(
    x = "PC1",
    y = "PC2",
    title = ""
  ) +
  coord_fixed(ratio = 1) +
  theme_bw(base_size = 20) +
  theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_text(color="black", size=10)
  ) 
dummy_data_with_pcs %>%
  dplyr::select(cell_type, starts_with("PC")) %>%
  pivot_longer(!cell_type, names_to = "PC", values_to = "value") %>%
  dplyr::mutate(PC = factor(PC, levels=paste0("PC",1:20))) %>%
  ggplot(., aes(x = value, y = cell_type)) +
  ggridges::geom_density_ridges(aes(fill = cell_type, color = cell_type), scale = 1) +
  facet_wrap(PC ~ ., ncol = 10, scales = "free") +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "loadings",
       y = "cell clusters") 
dummy_data_with_pcs %>%
  dplyr::select(disease, starts_with("PC")) %>%
  pivot_longer(!disease, names_to = "PC", values_to = "value") %>%
  dplyr::mutate(PC = factor(PC, levels=paste0("PC",1:20))) %>%
  ggplot(., aes(x = value, y = disease)) +
  ggridges::geom_density_ridges(aes(fill = disease, color = disease), scale = 1) +
  facet_wrap(PC ~ ., ncol = 10, scales = "free") +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "loadings",
       y = "disease") 
dummy_data_with_pcs %>%
  dplyr::select(batch, starts_with("PC")) %>%
  pivot_longer(!batch, names_to = "PC", values_to = "value") %>%
  dplyr::mutate(PC = factor(PC, levels=paste0("PC",1:20))) %>%
  ggplot(., aes(x = value, y = batch)) +
  ggridges::geom_density_ridges(aes(fill = batch, color = batch), scale = 1) +
  facet_wrap(PC ~ ., ncol = 10, scales = "free") +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "loadings",
       y = "batch") 
dummy_data_with_pcs %>%
  dplyr::select(sex, starts_with("PC")) %>%
  pivot_longer(!sex, names_to = "PC", values_to = "value") %>%
  dplyr::mutate(PC = factor(PC, levels=paste0("PC",1:20))) %>%
  ggplot(., aes(x = value, y = sex)) +
  ggridges::geom_density_ridges(aes(fill = sex, color = sex), scale = 1) +
  facet_wrap(PC ~ ., ncol = 10, scales = "free") +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "loadings",
       y = "sex") 

corrplot::corrplot(cor(pseudo_pcs_matrix))
```


# UMAP

```{r, message=FALSE, warning=FALSE}
umap_res <- uwot::umap(pseudo_pcs_matrix, 
                       n_neighbors = n_neighbors, 
                       metric = "cosine", 
                       min_dist = min_dist, 
                       n_threads = n_thread)
umap_res = umap_res %>% 
  magrittr::set_colnames(c("UMAP1","UMAP2")) %>%
  as.data.frame()

dummy_data_with_umap <- cbind(dummy_data, umap_res)
head(dummy_data_with_umap)

cluster_center <- data.frame(dummy_data, umap_res) %>%
  dplyr::group_by(cell_type) %>%
  dplyr::summarise_at(vars(UMAP1, UMAP2), dplyr::funs(median(., na.rm=TRUE)))
cluster_center <- as.data.frame(cluster_center)
ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "cell_type"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  geom_label_repel(
    data = cluster_center,
    aes(x = UMAP1, y = UMAP2, label = cell_type, fill = cell_type),
    color = "white",segment.color = "black",
    size = 7,
    min.segment.length = 0, seed = 42, box.padding = 0.8,
    max.overlaps = Inf
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = ""
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "subject_id"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by subject_id"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "disease"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by disease"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "batch"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by batch"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "age"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by age"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "bmi"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by bmi"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "sex"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by sex"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))
```



# LISI score

```{r}
lisi_res <- rbind(
  lisi::compute_lisi(pseudo_pcs_matrix, 
                     dummy_data,
                     c("subject_id", "sex", "disease", "batch", "cell_type"))
) %>% 
  tidyr::gather(key, val, subject_id, sex, disease, batch, cell_type)
print(head(lisi_res))

assign(paste0("lisi_res_cluster", cluster_ratio2,
              "_disease", disease_ratio, 
              "_sex", sex_ratio, 
              "_age", age_ratio,
              "_bmi", bmi_ratio,
              "_batch", batch_ratio2,
              "_individual", individual_ratio
              ), lisi_res)
```



# Association test by disease using CNA

```{r, warning=FALSE, message=FALSE}

dummy_data$condition_val = as.numeric(dummy_data[,disease_col])

nam_res = association_nam(seurat_object=NULL,
                          metadata=dummy_data,
                          pcs=pseudo_pcs_matrix,
                          test_var=test_var,
                          samplem_key = samplem_key,
                          graph_use = graph_use,
                          batches = batches,
                          covs = c(age_col,sex_col),
                          nsteps = nsteps,
                          verbose=verbose,
                          assay=assay,
                          key=key,
                          maxnsteps=maxnsteps,
                          max_frac_pcs=max_frac_pcs, # added option to pass number of PCs, for potential speedups
                          ks=ks,
                          Nnull=Nnull,
                          force_permute_all=force_permute_all,
                          local_test=local_test,
                          seed=seed,
                          return_nam=return_nam
)

```


# Visualization

```{r, fig.width=17, fig.height=25, warning=FALSE}


g0 = dummy_data %>%
  dplyr::group_by(subject_id,sex,disease,cell_type) %>%
  dplyr::summarise(count = dplyr::n()) %>%
  dplyr::group_by(subject_id,sex,disease) %>%
  dplyr::mutate(proportion = 100*count/sum(count),
                sex_label = ifelse(sex=="0","Male","Female"),
                disease_label = ifelse(disease=="0","Control","Disease")) %>%
  ggplot(.,aes(x=disease_label,y=proportion,color = disease_label)) +
  geom_boxplot() +
  geom_point(position=position_jitterdodge(0.9)) +
  ggpubr::stat_compare_means(comparisons = list(c("Control","Disease")), 
                             label = "{p.adj}{p.adj.signif}", method = "wilcox.test", label.y.npc = 0.4, tip.length = 0) +
  scale_color_manual(values = c(
    "Control" = "#4DAF4A",
    "Disease" = "#984EA3")) +
  ggh4x::facet_nested_wrap(vars(cell_type), nrow = 1) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15, angle = 45, hjust = 1),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(
    x = "Disease status",
    y = "Proportion (%)",
    title = ""
  )  


g1 = dummy_data %>%
  dplyr::group_by(subject_id,sex,disease,cell_type) %>%
  dplyr::summarise(count = dplyr::n()) %>%
  dplyr::group_by(subject_id,sex,disease) %>%
  dplyr::mutate(proportion = 100*count/sum(count),
                sex_label = ifelse(sex=="0","Male","Female"),
                disease_label = ifelse(disease=="0","Control","Disease")) %>%
  ggplot(.,aes(x=disease_label,y=proportion,color = disease_label)) +
  geom_boxplot() +
  geom_point(position=position_jitterdodge(0.9)) +
  ggpubr::stat_compare_means(comparisons = list(c("Control","Disease")), 
                             label = "{p.adj}{p.adj.signif}", method = "wilcox.test", label.y.npc = 0.4, tip.length = 0) +
  scale_color_manual(values = c(
    "Control" = "#4DAF4A",
    "Disease" = "#984EA3")) +
  ggh4x::facet_nested_wrap(vars(cell_type, sex_label), nrow = 1) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15, angle = 45, hjust = 1),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(
    x = "Disease status",
    y = "Proportion (%)",
    title = ""
  )  


cluster_center <- data.frame(dummy_data, umap_res) %>%
  dplyr::group_by(cell_type) %>%
  dplyr::summarise_at(vars(UMAP1, UMAP2), dplyr::funs(median(., na.rm=TRUE)))
cluster_center <- as.data.frame(cluster_center)
g2 = ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "cell_type"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  geom_label_repel(
    data = cluster_center,
    aes(x = UMAP1, y = UMAP2, label = cell_type, fill = cell_type),
    color = "white",segment.color = "black",
    size = 7,
    min.segment.length = 0, seed = 42, box.padding = 0.8,
    max.overlaps = Inf
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = ""
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

g3 = 
  data.frame(dummy_data_with_umap[,c("UMAP1","UMAP2")], ncorrs = nam_res@meta.data$cna_ncorrs_fdr05) %>%
  ggplot() +
  geom_point(aes(x = UMAP1, y = UMAP2, color = ncorrs, alpha = abs(ncorrs)), size = 0.01) +
  scale_color_gradient2(midpoint = 0, low = '#3C5488FF', mid = "grey90", high = '#DC0000FF', space = "Lab" ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = paste0("Disease association\n",sprintf("global p=%0.3f",nam_res@reductions$cna@misc$p)," [Filtered for FDR<0.05]"), 
    color = paste0("correlation"),
    alpha = paste0("correlation")
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

cor_pos = nam_res@meta.data$cna_ncorrs_fdr05
cor_pos = cor_pos[cor_pos > 0]
# summary(cor_pos)
cor_neg = nam_res@meta.data$cna_ncorrs_fdr05
cor_neg = cor_neg[cor_neg < 0]
# summary(cor_neg)
ord = sort(unique(dummy_data$cell_type))
p_ <- data.frame(dummy_data_with_umap[,c("UMAP1","UMAP2")], ncorrs = nam_res[["cna"]]@misc$ncorrs, res_cell = dummy_data$cell_type) %>%
  dplyr::mutate(res_cell = factor(res_cell,levels=ord)) %>%
  ggplot(aes(x=res_cell, y=ncorrs)) + 
  geom_violin(trim=TRUE, scale = "width")
mywidth <- .35 # bit of trial and error
# This is all you need for the fill: 
vl_fill <- data.frame(ggplot_build(p_)$data) %>%
  mutate(xnew = x- mywidth*violinwidth, xend = x+ mywidth*violinwidth) 
# Bit convoluted for the outline, need to be rearranged: the order matters
vl_poly <- 
  vl_fill %>% 
  dplyr::select(xnew, xend, y, group) %>%
  pivot_longer(-c(y, group), names_to = "oldx", values_to = "x") %>% 
  arrange(y) %>%
  split(., .$oldx) %>%
  map(., function(x) {
    if(all(x$oldx == "xnew")) x <- arrange(x, desc(y))
    x
  }) %>%
  bind_rows()
g4 = ggplot() +
  geom_polygon(data = vl_poly, aes(x, y, group = group), size = 1, fill = NA) +  
  geom_segment(data = vl_fill, aes(x = xnew, xend = xend, y = y, yend = y, color = y)) +
  scale_color_gradient2(midpoint = 0, low = '#3C5488FF', mid = "white", high = '#DC0000FF', space = "Lab") +
  scale_x_continuous(labels=ord, breaks=1:length(unique(ord)) , limits=c(min(vl_poly$x),max(vl_poly$x))) +
  geom_hline(yintercept=0, linetype='dashed', color='black') +
  geom_hline(yintercept=c(min(cor_pos), max(cor_neg)), linetype='dotted', color='grey45') +
  theme_classic() +
  coord_flip() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size =15),
        axis.text.x = element_text(size =15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "",
       y = "Neighborhood\nCorrelation") 

ord = c(paste0(rep(sort(unique(dummy_data$cell_type)),each=2),c(".Female",".Male")))
p_ <- data.frame(dummy_data_with_umap[,c("UMAP1","UMAP2")], ncorrs = nam_res@meta.data$cna_ncorrs, res_cell = dummy_data[,cluster_col], sex = ifelse(dummy_data[,sex_col]==1, "Female", "Male")) %>%
  dplyr::mutate(new_x = interaction(res_cell, sex),
                new_x = factor(new_x, levels=ord)) %>%
  ggplot(aes(x=new_x, y=ncorrs)) + 
  geom_violin(trim=TRUE, scale = "width") +
  scale_color_gradient2(midpoint = 0, low = '#3C5488FF', mid = "white", high = '#DC0000FF', space = "Lab")
mywidth <- .35 # bit of trial and error
# This is all you need for the fill: 
vl_fill <- data.frame(ggplot_build(p_)$data) %>%
  mutate(xnew = x- mywidth*violinwidth, xend = x+ mywidth*violinwidth) 
# Bit convoluted for the outline, need to be rearranged: the order matters
vl_poly <- 
  vl_fill %>% 
  dplyr::select(xnew, xend, y, group) %>%
  pivot_longer(-c(y, group), names_to = "oldx", values_to = "x") %>% 
  arrange(y) %>%
  split(., .$oldx) %>%
  map(., function(x) {
    if(all(x$oldx == "xnew")) x <- arrange(x, desc(y))
    x
  }) %>%
  bind_rows()
g5 =  ggplot() +
  geom_polygon(data = vl_poly, aes(x, y, group = group), size = 1, fill = NA) +  
  geom_segment(data = vl_fill, aes(x = xnew, xend = xend, y = y, yend = y, color = y)) +
  scale_color_gradient2(midpoint = 0, low = '#3C5488FF', mid = "white", high = '#DC0000FF', space = "Lab") +
  scale_x_continuous(labels=ord, breaks=1:length(ord) , limits=c(min(vl_poly$x),max(vl_poly$x))) +
  geom_hline(yintercept=0, linetype='dashed', color='black') +
  geom_hline(yintercept=c(min(cor_pos), max(cor_neg)), linetype='dotted', color='grey45') +
  theme_classic() +
  coord_flip() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size =12),
        axis.text.x = element_text(size =15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "",
       y = "Neighborhood\nCorrelation") 


(g0) / 
(g1) / 
  (g2 + g3 ) / 
  ((g4 + g5 ) + patchwork::plot_layout(nrow = 1, heights = c(1, 1, 1, 0.1)))


```


```{r, fig.width=10, fig.height=4}
LISI_df = rbind(
  eval(parse(text=paste0("lisi_res_cluster", cluster_ratio,
              "_disease", disease_ratio, 
              "_sex", sex_ratio, 
              "_age", age_ratio,
              "_bmi", bmi_ratio,
              "_batch", batch_ratio,
              "_individual", individual_ratio
              ))) %>%
    dplyr::mutate(group = "batch corrected"),
   eval(parse(text=paste0("lisi_res_cluster", cluster_ratio2,
              "_disease", disease_ratio, 
              "_sex", sex_ratio, 
              "_age", age_ratio,
              "_bmi", bmi_ratio,
              "_batch", batch_ratio2,
              "_individual", individual_ratio
              ))) %>%
    dplyr::mutate(group = "before")
)

ggplot(LISI_df) +
  geom_density(
    aes(x  = val, color = group) 
  ) +
  #   scale_x_continuous(limits = c(1, 15))+
  labs(
    title = "effect of batch correction",
    x = "LISI score",
    y = "Density"
  ) +
  facet_wrap( ~ key, scales = "free", ncol = 5) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) 

LISI_df %>% 
  ggplot(aes(x=key, y=val, fill=group)) +
  geom_boxplot() +
  ggpubr::stat_compare_means(method= "wilcox.test") +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) 
```


# keep cluster_ratio and decrease batch_ratio 


```{r}
# Define the maximum variance in PCs of each attribute
cluster_ratio3 = 0.2
batch_ratio3 = 0.01
```



# Generating dummy data

```{r, warning=FALSE}

dummy_data <- generate_dummy_metadata(n_cells = n_cells, # cells per individual
                                                sd_celltypes = sd_celltypes,  # standard deviation of number of cells 
                                                n_major_cell_types = n_major_cell_types,
                                                n_minor_cell_types = n_minor_cell_types,
                                                relative_abundance = relative_abundance, # ratio between major and rare
                                                n_major_diff_celltypes = n_major_diff_celltypes,
                                                n_minor_diff_celltypes = n_minor_diff_celltypes,
                                                
                                                n_individuals = n_individuals, # total individuals
                                                n_batchs = n_batchs,
                                                prop_sex = prop_sex, # proportion of feature 1 if feature 1 is categorical variable
                                                prop_disease = prop_disease,  # proportion of feature 2 if feature 2 is categorical variable
                                                fc_increase = fc_increase, # additional FC of specified cell types which are from people with case groups compared to control groups (e.g., if you specify 0.5, FC comparing increased cell type between case and control groups will be 1.5 in total)
                                                seed = seed
)
diff_cell_types = dummy_data[[2]]
dummy_data = dummy_data[[1]]

diff_cell_types
head(dummy_data)
dim(dummy_data)

dummy_data %>%
  dplyr::group_by(cell_type,subject_id,disease) %>%
  dplyr::summarise(count = dplyr::n()) %>%
  dplyr::filter(cell_type %in% diff_cell_types) %>%
  as.data.frame()

message(paste0("Fold change of ", paste0(diff_cell_types,collapse=","), " should be ", 1+fc_increase))
dummy_data %>%
  dplyr::group_by(cell_type,subject_id,disease) %>%
  dplyr::summarise(count = dplyr::n()) %>%
  dplyr::group_by(cell_type, disease) %>%
  dplyr::summarise(
    median_count = median(count), # 平均
    .groups = 'drop'
  ) %>%
  dplyr::ungroup() %>%
  tidyr::spread(key = disease, value = median_count) %>%
  dplyr::rename(median_count_disease_0 = `0`, median_count_disease_1 = `1`) %>%
  dplyr::mutate(
    fold_change = median_count_disease_1 / median_count_disease_0
  ) %>%
  dplyr::select(cell_type, median_count_disease_0, median_count_disease_1, fold_change)



# Generate 20 pseudo principal components for the data
## with the assumption that covariates including sex are removed after harmonization
pseudo_feature_matrix <- generate_pseudo_features(dummy_data, 
                                                  n_features = n_features, 
                                                  cluster_features = cluster_features,
                                                  disease_features = disease_features,
                                                  sex_features = sex_features, 
                                                  age_features = age_features,
                                                  bmi_features = bmi_features,
                                                  batch_features = batch_features,
                                                  individual_features = individual_features,
                                                  
                                                  # 各属性の割合の最大値を定義
                                                  cluster_ratio = cluster_ratio3,
                                                  disease_ratio = disease_ratio,
                                                  sex_ratio = sex_ratio,
                                                  age_ratio = age_ratio,
                                                  bmi_ratio = bmi_ratio,
                                                  batch_ratio = batch_ratio3,
                                                  individual_ratio = individual_ratio,
                                                  
                                                  ratio_variance = ratio_variance,
                                                  
                                                  cluster_col = cluster_col,
                                                  sex_col = sex_col,
                                                  age_col = age_col,
                                                  bmi_col = bmi_col,
                                                  batch_col = batch_col,
                                                  disease_col = disease_col,
                                                  individual_col = individual_col,
                                                  seed = seed,
                                                  
                                                  n_thread = 4,
                                                  verbose = TRUE
)
colnames(pseudo_feature_matrix) <- paste0("Feature", 1:ncol(pseudo_feature_matrix))


```



# Inspect the generated dummy data

```{r, fig.height=5, fig.width=6, warning=FALSE, message=FALSE}

# Set up a cluster using the available cores minus one
cl <- makeCluster(n_thread)

# Export the necessary objects and functions to the cluster
clusterExport(cl, list("apply_model_to_column", "dummy_data", "pseudo_feature_matrix"))

# Load the necessary packages on each worker
clusterEvalQ(cl, {
  library(lme4)
  library(variancePartition)
})

# Use parLapply to apply the function in parallel and capture errors
results_1 <- parLapply(cl, 1:10, function(col_index) {
  column_data <- pseudo_feature_matrix[, col_index]
  tryCatch({
    apply_model_to_column(column_data)
  }, error = function(e) {
    return(list(error = e$message))
  })
})

results_2 <- parLapply(cl, (ncol(pseudo_feature_matrix)-9):ncol(pseudo_feature_matrix), function(col_index) {
  column_data <- pseudo_feature_matrix[, col_index]
  tryCatch({
    apply_model_to_column(column_data)
  }, error = function(e) {
    return(list(error = e$message))
  })
})

stopCluster(cl)

results = c(results_1, results_2)

# Check for errors
## errors <- sapply(results, function(x) if(is.list(x)) x$error else NA)
## errors

# Assuming 'results' is your list of variance partitions
# Convert the list of results to a data frame
results_df <- do.call(rbind, lapply(results, function(x) as.data.frame(t(x))))
colnames(results_df) <- c('batch', 'cell_type', 'disease', 'sex', 'subject_id', 'age', 'bmi', 'Residuals')
results_df$Feature <- paste0("Feature", rownames(results_df))

# Convert the results into a long format for ggplot
results_long <- tidyr::gather(results_df, key = "variable", value = "variance", -Feature)

# Compute the percentage of variance explained by each variable for each Feature
results_long <- results_long %>%
  dplyr::group_by(Feature) %>%
  dplyr::mutate(percentage = (variance / sum(variance)) * 100) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Feature = factor(Feature, levels = paste0("Feature", 1:length(unique(results_long$Feature)))),
                variable = factor(variable, levels = c('cell_type', 'batch', 'disease', 'sex', 'subject_id', 'age', 'bmi', 'Residuals')))

# Create the stacked bar plot
ggplot(results_long, aes(x = Feature, y = percentage, fill = variable)) +
  geom_bar(stat = "identity") +
  labs(x = "Features", y = "Variance Explained (%)", title = "Variance Explained") +
  coord_flip() +
  scale_fill_brewer(palette = "Dark2") +
  theme_minimal() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)
        )

```

make PC matrix from Feature matrix;
batch effectなどが残っているシミュレーションをしているので、普通のPCAを使う

```{r}
pseudo_pcs_matrix_res <- irlba::prcomp_irlba(pseudo_feature_matrix, n_pcs)
pseudo_pcs_matrix_res$sdev^2 / sum(pseudo_pcs_matrix_res$sdev^2)
pseudo_pcs_matrix = pseudo_pcs_matrix_res$x
colnames(pseudo_pcs_matrix) <- paste0("PC", 1:ncol(pseudo_pcs_matrix))
```

```{r, fig.height=5, fig.width=6, warning=FALSE}

# Set up a cluster using the available cores minus one
cl <- makeCluster(n_thread)

# Export the necessary objects and functions to the cluster
clusterExport(cl, list("apply_model_to_column", "dummy_data", "pseudo_pcs_matrix"))

# Load the necessary packages on each worker
clusterEvalQ(cl, {
  library(lme4)
  library(variancePartition)
})

# Use parLapply to apply the function in parallel and capture errors
results <- parLapply(cl, 1:ncol(pseudo_pcs_matrix), function(col_index) {
  column_data <- pseudo_pcs_matrix[, col_index]
  tryCatch({
    apply_model_to_column(column_data)
  }, error = function(e) {
    return(list(error = e$message))
  })
})

stopCluster(cl)

# Check for errors
## errors <- sapply(results, function(x) if(is.list(x)) x$error else NA)
## errors

# Assuming 'results' is your list of variance partitions
# Convert the list of results to a data frame
results_df <- do.call(rbind, lapply(results, function(x) as.data.frame(t(x))))
colnames(results_df) <- c('batch', 'cell_type', 'disease', 'sex', 'subject_id', 'age', 'bmi', 'Residuals')
results_df$PC <- paste0("PC", rownames(results_df))

# Convert the results into a long format for ggplot
results_long <- tidyr::gather(results_df, key = "variable", value = "variance", -PC)

# Compute the percentage of variance explained by each variable for each PC
results_long <- results_long %>%
  dplyr::group_by(PC) %>%
  dplyr::mutate(percentage = (variance / sum(variance)) * 100) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(PC = factor(PC, levels = paste0("PC", 1:ncol(pseudo_pcs_matrix))),
                variable = factor(variable, levels = c('cell_type', 'batch', 'disease', 'sex', 'subject_id', 'age', 'bmi', 'Residuals')))

# Create the stacked bar plot
ggplot(results_long, aes(x = PC, y = percentage, fill = variable)) +
  geom_bar(stat = "identity") +
  labs(x = "Principal Component", y = "Variance Explained (%)", title = "Variance Explained") +
  coord_flip() +
  scale_fill_brewer(palette = "Dark2") +
  theme_minimal() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)
        )


```

```{r, message=FALSE, warning=FALSE, fig.height=6, fig.width=12}

dummy_data_with_pcs <- cbind(dummy_data, pseudo_pcs_matrix)
head(dummy_data_with_pcs)

cluster_center <- dummy_data_with_pcs %>%
  dplyr::group_by(cell_type) %>%
  dplyr::summarise_at(vars(PC1, PC2), dplyr::funs(median(., na.rm=TRUE)))
cluster_center <- as.data.frame(cluster_center)
ggplot() +
  geom_point(
    data = dummy_data_with_pcs,
    mapping = aes_string(x = "PC1", y = "PC2", color = "cell_type"),
    size = 1, stroke = 0, shape = 16,alpha = 0.5
  ) +
  geom_label_repel(
    data = cluster_center,
    aes(x = PC1, y = PC2, label = cell_type, fill = cell_type),
    color = "white",segment.color = "black",
    size = 7,
    min.segment.length = 0, seed = 42, box.padding = 0.8,
    max.overlaps = Inf
  ) +
  labs(
    x = "PC1",
    y = "PC2",
    title = ""
  ) +
  coord_fixed(ratio = 1) +
  theme_bw(base_size = 20) +
  theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_text(color="black", size=10)
  ) 
dummy_data_with_pcs %>%
  dplyr::select(cell_type, starts_with("PC")) %>%
  pivot_longer(!cell_type, names_to = "PC", values_to = "value") %>%
  dplyr::mutate(PC = factor(PC, levels=paste0("PC",1:20))) %>%
  ggplot(., aes(x = value, y = cell_type)) +
  ggridges::geom_density_ridges(aes(fill = cell_type, color = cell_type), scale = 1) +
  facet_wrap(PC ~ ., ncol = 10, scales = "free") +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "loadings",
       y = "cell clusters") 
dummy_data_with_pcs %>%
  dplyr::select(disease, starts_with("PC")) %>%
  pivot_longer(!disease, names_to = "PC", values_to = "value") %>%
  dplyr::mutate(PC = factor(PC, levels=paste0("PC",1:20))) %>%
  ggplot(., aes(x = value, y = disease)) +
  ggridges::geom_density_ridges(aes(fill = disease, color = disease), scale = 1) +
  facet_wrap(PC ~ ., ncol = 10, scales = "free") +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "loadings",
       y = "disease") 
dummy_data_with_pcs %>%
  dplyr::select(batch, starts_with("PC")) %>%
  pivot_longer(!batch, names_to = "PC", values_to = "value") %>%
  dplyr::mutate(PC = factor(PC, levels=paste0("PC",1:20))) %>%
  ggplot(., aes(x = value, y = batch)) +
  ggridges::geom_density_ridges(aes(fill = batch, color = batch), scale = 1) +
  facet_wrap(PC ~ ., ncol = 10, scales = "free") +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "loadings",
       y = "batch") 
dummy_data_with_pcs %>%
  dplyr::select(sex, starts_with("PC")) %>%
  pivot_longer(!sex, names_to = "PC", values_to = "value") %>%
  dplyr::mutate(PC = factor(PC, levels=paste0("PC",1:20))) %>%
  ggplot(., aes(x = value, y = sex)) +
  ggridges::geom_density_ridges(aes(fill = sex, color = sex), scale = 1) +
  facet_wrap(PC ~ ., ncol = 10, scales = "free") +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "loadings",
       y = "sex") 

corrplot::corrplot(cor(pseudo_pcs_matrix))
```


# UMAP

```{r, message=FALSE, warning=FALSE}
umap_res <- uwot::umap(pseudo_pcs_matrix, 
                       n_neighbors = n_neighbors, 
                       metric = "cosine", 
                       min_dist = min_dist, 
                       n_threads = n_thread)
umap_res = umap_res %>% 
  magrittr::set_colnames(c("UMAP1","UMAP2")) %>%
  as.data.frame()

dummy_data_with_umap <- cbind(dummy_data, umap_res)
head(dummy_data_with_umap)

cluster_center <- data.frame(dummy_data, umap_res) %>%
  dplyr::group_by(cell_type) %>%
  dplyr::summarise_at(vars(UMAP1, UMAP2), dplyr::funs(median(., na.rm=TRUE)))
cluster_center <- as.data.frame(cluster_center)
ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "cell_type"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  geom_label_repel(
    data = cluster_center,
    aes(x = UMAP1, y = UMAP2, label = cell_type, fill = cell_type),
    color = "white",segment.color = "black",
    size = 7,
    min.segment.length = 0, seed = 42, box.padding = 0.8,
    max.overlaps = Inf
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = ""
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "subject_id"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by subject_id"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "disease"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by disease"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "batch"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by batch"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "age"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by age"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "bmi"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by bmi"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "sex"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = "color by sex"
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))
```



# LISI score

```{r}
lisi_res <- rbind(
  lisi::compute_lisi(pseudo_pcs_matrix, 
                     dummy_data,
                     c("subject_id", "sex", "disease", "batch", "cell_type"))
) %>% 
  tidyr::gather(key, val, subject_id, sex, disease, batch, cell_type)
print(head(lisi_res))

assign(paste0("lisi_res_cluster", cluster_ratio3,
              "_disease", disease_ratio, 
              "_sex", sex_ratio, 
              "_age", age_ratio,
              "_bmi", bmi_ratio,
              "_batch", batch_ratio3,
              "_individual", individual_ratio
              ), lisi_res)
```



# Association test by disease using CNA

```{r, warning=FALSE, message=FALSE}

dummy_data$condition_val = as.numeric(dummy_data[,disease_col])

nam_res = association_nam(seurat_object=NULL,
                          metadata=dummy_data,
                          pcs=pseudo_pcs_matrix,
                          test_var=test_var,
                          samplem_key = samplem_key,
                          graph_use = graph_use,
                          batches = batches,
                          covs = c(age_col,sex_col),
                          nsteps = nsteps,
                          verbose=verbose,
                          assay=assay,
                          key=key,
                          maxnsteps=maxnsteps,
                          max_frac_pcs=max_frac_pcs, # added option to pass number of PCs, for potential speedups
                          ks=ks,
                          Nnull=Nnull,
                          force_permute_all=force_permute_all,
                          local_test=local_test,
                          seed=seed,
                          return_nam=return_nam
)

```


# Visualization

```{r, fig.width=17, fig.height=25, warning=FALSE}


g0 = dummy_data %>%
  dplyr::group_by(subject_id,sex,disease,cell_type) %>%
  dplyr::summarise(count = dplyr::n()) %>%
  dplyr::group_by(subject_id,sex,disease) %>%
  dplyr::mutate(proportion = 100*count/sum(count),
                sex_label = ifelse(sex=="0","Male","Female"),
                disease_label = ifelse(disease=="0","Control","Disease")) %>%
  ggplot(.,aes(x=disease_label,y=proportion,color = disease_label)) +
  geom_boxplot() +
  geom_point(position=position_jitterdodge(0.9)) +
  ggpubr::stat_compare_means(comparisons = list(c("Control","Disease")), 
                             label = "{p.adj}{p.adj.signif}", method = "wilcox.test", label.y.npc = 0.4, tip.length = 0) +
  scale_color_manual(values = c(
    "Control" = "#4DAF4A",
    "Disease" = "#984EA3")) +
  ggh4x::facet_nested_wrap(vars(cell_type), nrow = 1) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15, angle = 45, hjust = 1),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(
    x = "Disease status",
    y = "Proportion (%)",
    title = ""
  )  


g1 = dummy_data %>%
  dplyr::group_by(subject_id,sex,disease,cell_type) %>%
  dplyr::summarise(count = dplyr::n()) %>%
  dplyr::group_by(subject_id,sex,disease) %>%
  dplyr::mutate(proportion = 100*count/sum(count),
                sex_label = ifelse(sex=="0","Male","Female"),
                disease_label = ifelse(disease=="0","Control","Disease")) %>%
  ggplot(.,aes(x=disease_label,y=proportion,color = disease_label)) +
  geom_boxplot() +
  geom_point(position=position_jitterdodge(0.9)) +
  ggpubr::stat_compare_means(comparisons = list(c("Control","Disease")), 
                             label = "{p.adj}{p.adj.signif}", method = "wilcox.test", label.y.npc = 0.4, tip.length = 0) +
  scale_color_manual(values = c(
    "Control" = "#4DAF4A",
    "Disease" = "#984EA3")) +
  ggh4x::facet_nested_wrap(vars(cell_type, sex_label), nrow = 1) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15, angle = 45, hjust = 1),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(
    x = "Disease status",
    y = "Proportion (%)",
    title = ""
  )  


cluster_center <- data.frame(dummy_data, umap_res) %>%
  dplyr::group_by(cell_type) %>%
  dplyr::summarise_at(vars(UMAP1, UMAP2), dplyr::funs(median(., na.rm=TRUE)))
cluster_center <- as.data.frame(cluster_center)
g2 = ggplot() +
  geom_point(
    data = data.frame(dummy_data, umap_res),
    mapping = aes_string(x = "UMAP1", y = "UMAP2", color = "cell_type"),
    size = 1, stroke = 0, shape = 16,alpha = 0.3
  ) +
  geom_label_repel(
    data = cluster_center,
    aes(x = UMAP1, y = UMAP2, label = cell_type, fill = cell_type),
    color = "white",segment.color = "black",
    size = 7,
    min.segment.length = 0, seed = 42, box.padding = 0.8,
    max.overlaps = Inf
  ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = ""
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

g3 = 
  data.frame(dummy_data_with_umap[,c("UMAP1","UMAP2")], ncorrs = nam_res@meta.data$cna_ncorrs_fdr05) %>%
  ggplot() +
  geom_point(aes(x = UMAP1, y = UMAP2, color = ncorrs, alpha = abs(ncorrs)), size = 0.01) +
  scale_color_gradient2(midpoint = 0, low = '#3C5488FF', mid = "grey90", high = '#DC0000FF', space = "Lab" ) +
  labs(
    x = "UMAP1",
    y = "UMAP2",
    title = paste0("Disease association\n",sprintf("global p=%0.3f",nam_res@reductions$cna@misc$p)," [Filtered for FDR<0.05]"), 
    color = paste0("correlation"),
    alpha = paste0("correlation")
  ) +
  coord_fixed(ratio = 1.2) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black"),
        strip.text.y=element_text(size=15, color="black"),
        strip.placement = "outside", 
        strip.background.x=element_rect(color = NA,  fill=NA), 
        strip.background.y=element_rect(color = "black",  fill=NA),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 10),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 10, hjust = 0))

cor_pos = nam_res@meta.data$cna_ncorrs_fdr05
cor_pos = cor_pos[cor_pos > 0]
# summary(cor_pos)
cor_neg = nam_res@meta.data$cna_ncorrs_fdr05
cor_neg = cor_neg[cor_neg < 0]
# summary(cor_neg)
ord = sort(unique(dummy_data$cell_type))
p_ <- data.frame(dummy_data_with_umap[,c("UMAP1","UMAP2")], ncorrs = nam_res[["cna"]]@misc$ncorrs, res_cell = dummy_data$cell_type) %>%
  dplyr::mutate(res_cell = factor(res_cell,levels=ord)) %>%
  ggplot(aes(x=res_cell, y=ncorrs)) + 
  geom_violin(trim=TRUE, scale = "width")
mywidth <- .35 # bit of trial and error
# This is all you need for the fill: 
vl_fill <- data.frame(ggplot_build(p_)$data) %>%
  mutate(xnew = x- mywidth*violinwidth, xend = x+ mywidth*violinwidth) 
# Bit convoluted for the outline, need to be rearranged: the order matters
vl_poly <- 
  vl_fill %>% 
  dplyr::select(xnew, xend, y, group) %>%
  pivot_longer(-c(y, group), names_to = "oldx", values_to = "x") %>% 
  arrange(y) %>%
  split(., .$oldx) %>%
  map(., function(x) {
    if(all(x$oldx == "xnew")) x <- arrange(x, desc(y))
    x
  }) %>%
  bind_rows()
g4 = ggplot() +
  geom_polygon(data = vl_poly, aes(x, y, group = group), size = 1, fill = NA) +  
  geom_segment(data = vl_fill, aes(x = xnew, xend = xend, y = y, yend = y, color = y)) +
  scale_color_gradient2(midpoint = 0, low = '#3C5488FF', mid = "white", high = '#DC0000FF', space = "Lab") +
  scale_x_continuous(labels=ord, breaks=1:length(unique(ord)) , limits=c(min(vl_poly$x),max(vl_poly$x))) +
  geom_hline(yintercept=0, linetype='dashed', color='black') +
  geom_hline(yintercept=c(min(cor_pos), max(cor_neg)), linetype='dotted', color='grey45') +
  theme_classic() +
  coord_flip() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size =15),
        axis.text.x = element_text(size =15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "",
       y = "Neighborhood\nCorrelation") 

ord = c(paste0(rep(sort(unique(dummy_data$cell_type)),each=2),c(".Female",".Male")))
p_ <- data.frame(dummy_data_with_umap[,c("UMAP1","UMAP2")], ncorrs = nam_res@meta.data$cna_ncorrs, res_cell = dummy_data[,cluster_col], sex = ifelse(dummy_data[,sex_col]==1, "Female", "Male")) %>%
  dplyr::mutate(new_x = interaction(res_cell, sex),
                new_x = factor(new_x, levels=ord)) %>%
  ggplot(aes(x=new_x, y=ncorrs)) + 
  geom_violin(trim=TRUE, scale = "width") +
  scale_color_gradient2(midpoint = 0, low = '#3C5488FF', mid = "white", high = '#DC0000FF', space = "Lab")
mywidth <- .35 # bit of trial and error
# This is all you need for the fill: 
vl_fill <- data.frame(ggplot_build(p_)$data) %>%
  mutate(xnew = x- mywidth*violinwidth, xend = x+ mywidth*violinwidth) 
# Bit convoluted for the outline, need to be rearranged: the order matters
vl_poly <- 
  vl_fill %>% 
  dplyr::select(xnew, xend, y, group) %>%
  pivot_longer(-c(y, group), names_to = "oldx", values_to = "x") %>% 
  arrange(y) %>%
  split(., .$oldx) %>%
  map(., function(x) {
    if(all(x$oldx == "xnew")) x <- arrange(x, desc(y))
    x
  }) %>%
  bind_rows()
g5 =  ggplot() +
  geom_polygon(data = vl_poly, aes(x, y, group = group), size = 1, fill = NA) +  
  geom_segment(data = vl_fill, aes(x = xnew, xend = xend, y = y, yend = y, color = y)) +
  scale_color_gradient2(midpoint = 0, low = '#3C5488FF', mid = "white", high = '#DC0000FF', space = "Lab") +
  scale_x_continuous(labels=ord, breaks=1:length(ord) , limits=c(min(vl_poly$x),max(vl_poly$x))) +
  geom_hline(yintercept=0, linetype='dashed', color='black') +
  geom_hline(yintercept=c(min(cor_pos), max(cor_neg)), linetype='dotted', color='grey45') +
  theme_classic() +
  coord_flip() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "none",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size =12),
        axis.text.x = element_text(size =15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) +
  labs(title = "",
       x = "",
       y = "Neighborhood\nCorrelation") 


(g0) / 
(g1) / 
  (g2 + g3 ) / 
  ((g4 + g5 ) + patchwork::plot_layout(nrow = 1, heights = c(1, 1, 1, 0.1)))


```


```{r, fig.width=10, fig.height=4}
LISI_df = rbind(
  eval(parse(text=paste0("lisi_res_cluster", cluster_ratio,
              "_disease", disease_ratio, 
              "_sex", sex_ratio, 
              "_age", age_ratio,
              "_bmi", bmi_ratio,
              "_batch", batch_ratio,
              "_individual", individual_ratio
              ))) %>%
    dplyr::mutate(group = "batch corrected"),
   eval(parse(text=paste0("lisi_res_cluster", cluster_ratio3,
              "_disease", disease_ratio, 
              "_sex", sex_ratio, 
              "_age", age_ratio,
              "_bmi", bmi_ratio,
              "_batch", batch_ratio3,
              "_individual", individual_ratio
              ))) %>%
    dplyr::mutate(group = "before")
)

ggplot(LISI_df) +
  geom_density(
    aes(x  = val, color = group) 
  ) +
  #   scale_x_continuous(limits = c(1, 15))+
  labs(
    title = "effect of batch correction",
    x = "LISI score",
    y = "Density"
  ) +
  facet_wrap( ~ key, scales = "free", ncol = 5) +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) 

LISI_df %>% 
  ggplot(aes(x=key, y=val, fill=group)) +
  geom_boxplot() +
  ggpubr::stat_compare_means(method= "wilcox.test") +
  theme_classic() +
  theme(strip.text.x=element_text(size=15, color="black", face="bold"),
        strip.text.y=element_text(size=15, color="black", face="bold"),
        legend.position = "right",
        plot.title = element_text(size=15),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size =15),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        legend.text =  element_text(size = 15),
        legend.key.size = grid::unit(0.5, "lines"),
        legend.title = element_text(size = 0.8, hjust = 0)) 
```



